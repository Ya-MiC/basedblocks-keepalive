// â€”â€” å…¨å±€å˜é‡
let lastAttempt = null;
let lastValidHashTime = 0;

// â€”â€” æ‹¦æˆªå¹¶æ‰©å±• console.log
(function() {
  const origLog = console.log;
  console.log = function(...args) {
    const msg = args[0];
    if (typeof msg === 'string' &&
       (msg.includes("Valid hash found:")  // è‹±æ–‡æ—¥å¿—
     || msg.includes("æ‰¾åˆ°æœ‰æ•ˆçš„å“ˆå¸Œå€¼ï¼š") // ä¸­æ–‡æ—¥å¿—
       )) {
      console.warn("â›ï¸ æœ‰æ•ˆå“ˆå¸Œæ£€æµ‹åˆ°ï¼Œè§¦å‘é‡å¯...");
      lastValidHashTime = Date.now();
      restartMining();
    }
    origLog.apply(console, args);
  };
})();

// â€”â€” è·å–å°è¯•æ¬¡æ•°çš„å…ƒç´ ï¼ˆè‹±/ä¸­ä¸¤ç§åœºæ™¯ï¼‰
function getAttemptDiv() {
  return Array.from(document.querySelectorAll('div.pixel-text')).find(el =>
    /attempt:/.test(el.textContent) || /å°è¯•ï¼š/.test(el.textContent)
  );
}

// â€”â€” è·å–åœæ­¢/å¼€å§‹æŒ‰é’®ï¼ˆè‹±/ä¸­ä¸¤ç§åœºæ™¯ï¼‰
function getStopButton() {
  return Array.from(document.querySelectorAll('button')).find(btn =>
    btn.textContent.includes('STOP MINING')
     || btn.textContent.includes('åœæ­¢æŒ–çŸ¿')
  );
}
function getStartButton() {
  return Array.from(document.querySelectorAll('button')).find(btn =>
    btn.textContent.includes('START MINING')
     || btn.textContent.includes('å¼€å§‹æŒ–çŸ¿')
  );
}

// â€”â€” é‡å¯æµç¨‹ï¼šå…ˆç‚¹â€œåœæ­¢â€ï¼Œå†å»¶è¿Ÿ 1 ç§’ç‚¹â€œå¼€å§‹â€
function restartMining() {
  const stopBtn = getStopButton();
  const startBtn = getStartButton();
  if (stopBtn) stopBtn.click();
  setTimeout(() => {
    if (startBtn) startBtn.click();
  }, 1000);
}

// â€”â€” å®šæ—¶æ£€æŸ¥â€œå°è¯•æ¬¡æ•°â€æ˜¯å¦å¡ä½
setInterval(() => {
  const el = getAttemptDiv();
  if (!el) return;
  const m = el.textContent.match(/(?:attempt:|å°è¯•ï¼š)\s*(\d+)/);
  if (!m) return;
  const currentAttempt = parseInt(m[1], 10);

  // å¦‚æœæ¬¡æ•°ä¸å˜ä¸”è·ä¸Šæ¬¡æœ‰æ•ˆå“ˆå¸Œè¶… 5 ç§’ï¼Œåˆ™é‡å¯
  if (lastAttempt !== null
      && currentAttempt === lastAttempt
      && Date.now() - lastValidHashTime > 5000) {
    console.warn("ğŸ“· å°è¯•å¡ä½ï¼Œé‡å¯æŒ–çŸ¿...");
    restartMining();
  }
  lastAttempt = currentAttempt;
}, 1000);
